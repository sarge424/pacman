<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <style>
        canvas {
            border: 1px solid #333333;
            background-color: #000000;
            cursor: none;
        }
    </style>
    <title>pac</title>
</head>

<body onload="startGame()">
<script>
    let pacman;
	let blinky;
	let frame;

    function startGame() {
        arena.start();
        pacman = new char(200 + 10, 400 + 10, 'yellow', 20, 2.5);//sp must come to 20 sometime!!!!!!
		blinky = new char(220 + 10, 180 + 10, 'red', 10, 2.5);
		frame = 0;
    }
	
	gts = {
		//bips
		blx: 10,
		bly: 10,
		updateGTS: function(){
			let px = pacman.x;
			let py = pacman.y;
			//blinky back
			this.blx = (px - px%20)/20;
			this.bly = (py - py%20)/20;
			
			//pinky left
			//inky front
			//clyde back
		}
	}
	
    arena = {
        canvas: document.createElement('canvas'),
        key: null,
		maze: [
				[1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1],
				[1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1],
				[1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1],
				[1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1],
				[1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1],
				[1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 1],
				[1, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1],
				[1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1],
				[1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1],
				[1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1],
				[1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 3, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1],
				[0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
				[1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1],
				[1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1],
				[1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1],
				[1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1],
				[1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1],
				[1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1],
				[1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 1],
				[1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1],
				[1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1],
				[1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1],
				[1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1],
				[0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0]
			],
        start: function () {
			
            this.canvas.width = this.maze[1].length * 20;
            this.canvas.height = this.maze.length * 20;
            this.canvas.style.align = 'center';
            this.context = this.canvas.getContext("2d");
            document.body.insertBefore(this.canvas, document.body.childNodes[0]);
            this.interval = setInterval(updateGameArea, 20);
            
            window.addEventListener('keydown', function (e) {
                arena.key = e.keyCode;
            })
            window.addEventListener('keyup', function (e) {
                this.key = false;
            })
        },
	draw: function () {
		let ctx = this.context;
		for(let x = 0; x < this.maze.length; x++){
			for(let y = 0; y < this.maze[0].length; y++){
				if(this.maze[x][y] === 1 || this.maze[x][y] === 3){ctx.beginPath();
				ctx.fillStyle = '#0000aa';
				if(this.maze[x][y] === 1)
					ctx.rect(y * 20, x * 20, 20, 20);
				else
					ctx.rect(y * 20, x * 20 + 5, 20, 10);
				ctx.fill();
				}
			}
		}
	},
        clear: function () {
            this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },

        stop: function () {
            clearInterval(this.interval);
        }
    }

    function updateGameArea() {
        frame += 1;
        arena.clear();
		arena.draw();
        pacman.pac();
		gts.updateGTS();
		blinky.ghost();
    }

    function char(x, y, color, size, sp) {
		this.realx = x;
        this.x = x;
		this.realy = y;
        this.y = y;
        this.dir = 1;
		this.ndir = -1;
        this.color = color;
		this.size =  size;
		this.sp = sp;
		this.p = 0;
		this.pd = 1;
        this.draw = function () {
			if(this.realx < 0)
				this.realx += arena.canvas.width;
			if(this.realx > arena.canvas.width)
				this.realx -= arena.canvas.width;
			this.getCoords();
            let ctx = arena.context;
            ctx.beginPath();
            ctx.fillStyle = this.color;
            ctx.arc(this.x, this.y, size/2, 0, Math.PI * 2);
            ctx.fill();
        }
        this.pac = function () {
            if (arena.key === 37) 
                this.ndir = 0;
            if (arena.key === 38) 
                this.ndir = 1;
            if (arena.key === 39) 
                this.ndir = 2;
            if (arena.key === 40) 
				this.ndir = 3;
			
			this.move();
			this.draw();
        }
		this.move = function(){
			if((this.x-10)%20 === 0 && (this.y-10)%20 === 0){
				let posx = (this.x - this.x%20)/20;
				let posy = (this.y - this.y%20)/20;
				if(this.ndir === 0 && (arena.maze[posy][posx-1] === 1 || arena.maze[posy][posx-1] === 3)){
					this.ndir = this.dir;
				}else if(this.ndir === 1 && (arena.maze[posy-1][posx] === 1 || arena.maze[posy-1][posx] === 3)){
					this.ndir = this.dir;
				}else if(this.ndir === 2 && (arena.maze[posy][posx+1] === 1 || arena.maze[posy][posx+1] === 3)){
					this.ndir = this.dir;
				}else if(this.ndir === 3 && (arena.maze[posy+1][posx] === 1 || arena.maze[posy+1][posx] === 3)){
					this.ndir = this.dir;
				}
				if(this.ndir === 0 && (arena.maze[posy][posx-1] === 1 || arena.maze[posy][posx-1] === 3)){
					this.ndir = -1;
				}else if(this.ndir === 1 && (arena.maze[posy-1][posx] === 1 || arena.maze[posy-1][posx] === 3)){
					this.ndir = -1;
				}else if(this.ndir === 2 && (arena.maze[posy][posx+1] === 1 || arena.maze[posy][posx+1] === 3)){
					this.ndir = -1;
				}else if(this.ndir === 3 && (arena.maze[posy+1][posx] === 1 || arena.maze[posy+1][posx] === 3)){
					this.ndir = -1;
				}
				this.dir = this.ndir;
			}
		
			if (this.dir === 0)
				this.realx -= this.sp;
			if (this.dir === 1)
				this.realy -= this.sp;
			if (this.dir === 2)
				this.realx += this.sp;
			if (this.dir === 3)
				this.realy += this.sp;
			this.getCoords();
		}
		this.getCoords = function(){
			this.x = Math.round(this.realx);
			this.y = Math.round(this.realy);
		}
		this.ghost = function(){
			let nextdirs = getdir(this, gts.blx, gts.bly);
			
			if((this.x-10)%20 === 0 && (this.y-10)%20 === 0 && frame - this.p > this.pd +1){
				let posx = (this.x - this.x%20)/20;
				let posy = (this.y - this.y%20)/20;
				let reverse = (this.dir+2)%4;
				let olddir = this.dir;
				
				for(let x = 0; x < 4; x++){
					if(nextdirs[x] !== reverse){
						if(nextdirs[x] === 0 && arena.maze[posy][posx-1] !== 1){
							this.dir = nextdirs[x];
							if(this.dir !== olddir)
								this.p = frame;
							break;
						}else if(nextdirs[x] === 1 && arena.maze[posy-1][posx] === 0){
							this.dir = nextdirs[x];
							if(this.dir !== olddir)
								this.p = frame;
							break;
						}else if(nextdirs[x] === 2 && arena.maze[posy][posx+1] === 0){
							this.dir = nextdirs[x];
							if(this.dir !== olddir)
								this.p = frame;
							break;
						}else if(nextdirs[x] === 3 && arena.maze[posy+1][posx] === 0){
							this.dir = nextdirs[x];
							if(this.dir !== olddir)
								this.p = frame;
							break;
						}
					}
				}
				
				if(posx === gts.blx && posy === gts.bly)
					this.dir = -1;
			}
			if(frame - this.p > this.pd){//pause at turns
				if (this.dir === 0) 
					this.realx -= this.sp;
				if (this.dir === 1) 
					this.realy -= this.sp;
				if (this.dir === 2) 
					this.realx += this.sp;
				if (this.dir === 3) 
					this.realy += this.sp;
				this.getCoords();
			}
			this.draw();

		}
    }

	getdir = function(ghost, tx, ty){
		var dx = tx - (ghost.x-ghost.x%20)/20;
        var dy = ty - (ghost.y-ghost.y%20)/20;
		
		var angle = Math.atan2(dy, dx) * (180/Math.PI);
		
		let dirs = [];
		
		if(angle <= 45 && angle > 0)
			dirs = [2, 3, 1, 0];
		else if(angle <= 90 && angle > 45)
			dirs = [3, 2, 0, 1];
		else if(angle <= 135 && angle > 90)
			dirs = [3, 0, 2, 1];
		else if(angle <= 180 && angle > 135)
			dirs = [0, 3, 1, 2];
		else if(angle <= 0 && angle > -45)
			dirs = [2, 1, 3, 0];
		else if(angle <= -45 && angle > -90)
			dirs = [1, 2, 0, 3];
		else if(angle <= -90 && angle > -135)
			dirs = [1, 0, 2, 3];
		else if(angle <= -135 && angle > -180)
			dirs = [0, 1, 3, 2];
		return dirs;
	}
</script>
</body>
</html>